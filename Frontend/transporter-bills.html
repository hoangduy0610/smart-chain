<!doctype html>
<html lang="en">

<head>
  <title>Provanence Tracking</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">
  <script src="https://kit.fontawesome.com/d6862fa655.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.css" />
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/main.css">
</head>

<body>
  <div class="loader-container">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
  <div id="page-wrapper" class="wrapper d-flex align-items-stretch">
    <!-- Page Content  -->
    <div id="content" class="p-4 p-md-5">
      <h2 class="mb-4">Provanence Tracking</h2>
      <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#qrscanCollapse"
        aria-expanded="false" aria-controls="qrscanCollapse">
        Tạo đơn vận
      </button>
      <div class="collapse" id="qrscanCollapse">
        <div style="max-width:500px;" class="card card-body p-3 mt-2">
          <div style="width: 100%;" id="reader"></div>
        </div>
      </div>
      <div class="text-center mt-2">
        <div class="table-responsive">
          <!--Table-->
          <table id="billsTable" class="table table-hover table-bordered mb-0">

            <!--Table head-->
            <thead>
              <tr>
                <th class="th-lg">
                  <a href="#">Image
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">From
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">To
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">Length
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">Status
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">Current Position
                  </a>
                </th>
              </tr>
            </thead>
            <!--Table head-->

            <!--Table body-->
            <tbody>
            </tbody>
            <!--Table body-->

            <!--Table foot-->
            <tfoot>
              <tr>
                <th class="th-lg">
                  <a href="#">Image
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">From
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">To
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">Length
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">Status
                  </a>
                </th>
                <th class="th-lg">
                  <a href="#">Current Position
                  </a>
                </th>
              </tr>
            </tfoot>
            <!--Table foot-->
          </table>
          <!--Table-->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
  <script src="./plugins/html5-qrcode.min.js"></script>
  <script src="./js/apis.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/main.js"></script>
  <script>
    $(document).ready(function () {
      $("body").tooltip({ selector: '[data-bs-toggle=tooltip]' });
      const userInfo = JSON.parse(localStorage.getItem('@auth/userInfo'));
      const tableRenderColumns = [
        {
          "data": 'batchId',
          render: function (data, type, row, meta) {
            return `
              <div class="d-flex flex-1 justify-content-center">
                <div id="loader${row._id}" style="width:5vw;height:5vw;" class="linear-background"></div>
                <img class='d-none' style="max-width:5vw" id="qr${row._id}"onload='(function(){document.getElementById("qr${row._id}").classList.remove("d-none");document.getElementById("loader${row._id}").classList.add("d-none")})()' src='${QR_HOST}${data}'/>
              </div>
            `;
          }
        },
        {
          "data": 'departure',
          render: function (data, type, row, meta) {
            const data_arr = data.split(";");
            const lat = data_arr[0];
            const long = data_arr[1];
            const address = data_arr[2];
            return `
              <a
                href="https://maps.google.com/?q=${lat},${long}" target="_blank"
                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="${address}"
              >
                ${truncate(address, 25)} &nbsp;<i class="fa-solid fa-arrow-up-right-from-square"></i>
              </a>
            `;
          }
        },
        {
          "data": 'destination',
          render: function (data, type, row, meta) {
            const data_arr = data.split(";");
            const lat = data_arr[0];
            const long = data_arr[1];
            const address = data_arr[2];
            return `
              <a
                href="https://maps.google.com/?q=${lat},${long}" target="_blank"
                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="${address}"
              >
                ${truncate(address, 25)} &nbsp;<i class="fa-solid fa-arrow-up-right-from-square"></i>
              </a>
            `;
          }
        },
        {
          data: 'length',
          render: function (data, type, row, meta) {
            return `${Math.round(data / 10) / 100} km`;
          }
        },
        {
          data: 'status',
          render: function (data, type, row, meta) {
            return `<span class="badge p-2 bg-${row.status == "StartTransport" ? "success" : "danger"}">${row.status}</span>`;
          }
        },
        {
          "data": 'currentPos',
          render: function (data, type, row, meta) {
            const dep = row.departure.split(";");
            const des = row.destination.split(";");
            const data_arr = data.split(";");
            const lat = data_arr[0];
            const long = data_arr[1];
            const address = data_arr[2];
            return `
              <a
                href="https://www.google.com/maps/dir/?api=1&origin=${dep[0]},${dep[1]}&destination=${des[0]},${des[1]}&waypoints=${lat},${long}" target="_blank"
                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="${address}"
              >
                ${truncate(address, 25)} &nbsp;<i class="fa-solid fa-arrow-up-right-from-square"></i>
              </a>
            `;
          }
        },
        {
          data: 'null',
          render: function (data, type, row, meta) {
            const isDisabled =
              !userInfo.roles.includes('ROLE_TRANSPORTER') &&
              !userInfo.roles.includes('ROLE_ADMIN') ||
              row.status != "StartTransport"

            const dsb = !isDisabled ? '' : 'disabled';
            const dep = row.departure.split(";");
            const des = row.destination.split(";");
            return `
              <div class="d-flex p-2 justify-content-center">
                <a
                  target="_blank"
                  href="https://www.google.com/maps/dir/?api=1&origin=${dep[0]},${dep[1]}&destination=${des[0]},${des[1]}"
                  role="button"
                  class="btn btn-primary m-1"
                  data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Open Route"
                ><i class="fa-solid fa-route"></i></a>
                <button
                  type="button"
                  class="btn btn-danger btn-update-pos m-1"
                  data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Update Current Position"
                ><i class="fa-solid fa-location-dot"></i></button>
                <button
                  type="button" class="btn btn-${dsb ? 'secondary' : 'indigo'} btn-forward-batch m-1" ${dsb}
                  data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Chuyển tiếp"
                ><i class="fa-solid fa-forward-fast"></i></button>
              </div>
            `;
          }
        },
      ]
      const billsTable = initDataTable('#billsTable', { ajaxUrl: API_ENDPOINT.TRANSPORTER_BILLS.LIST_TRANSPORTER_BILLS }, tableRenderColumns);

      var html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: 250 });

      function onScanSuccess(decodedText, decodedResult) {
        // Handle on success condition with the decoded text or result.
        const batchId = decodedText.split("?id=")[1];
        var answer = window.confirm(`Scanning batchId: ${batchId}`);
        if (answer) {
          //some code
          window.location.href = `form-transporter-bills.html?id=${batchId}`;
        }
        $("#html5-qrcode-button-camera-stop").click();
      }

      function onScanError(errorMessage) {
        // handle on error condition, with error message
      }

      $("#qrscanCollapse").on('show.bs.collapse', function () {
        html5QrcodeScanner.render(onScanSuccess, onScanError);
        $("button[data-bs-target='#qrscanCollapse']").html("Tắt máy quét")
      });

      $("#qrscanCollapse").on('hide.bs.collapse', function () {
        $("#html5-qrcode-button-camera-stop").click();
        $("button[data-bs-target='#qrscanCollapse']").html("Tạo đơn vận")
        // html5QrcodeScanner.clear();
      });

      $('#billsTable tbody').on('click', '.btn-update-pos', function () {
        $(".loader-container").addClass('active');
        const row = $(this).parents('tr')[0];
        const data = billsTable.row(row).data();
        const id = data._id;
        const batchId = data.batchId;

        getLocation((position) => {
          console.log(position.coords.latitude, position.coords.longitude);
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          $.ajax({
            url: fillEndpointPlaceholder(API_ENDPOINT.GEOCODING.REVERSE_GEOCODING, { lat: lat, lon: lng }),
            type: 'GET',
            success: function (data) {
              $.ajax({
                url: fillEndpointPlaceholder(API_ENDPOINT.TRANSPORTER_BILLS.UPDATE_TRANSPORTER_BILLS, { id: id }),
                type: 'PUT',
                headers: {
                  'Authorization': ACCESS_TOKEN,
                },
                data: {
                  currentPos: `${lat};${lng};${data.display_name}`,
                },
                success: function (response) {
                  alert("Update position successfully!")
                  $(".loader-container").removeClass('active');
                  billsTable.ajax.reload();
                },
                error: function (xhr, status, error) {
                  alert("Update position failed!")
                  $(".loader-container").removeClass('active');
                }
              });

              const actionText = `Nhà vận chuyển ${userInfo.name} đã cập nhật vị trí hiện tại: ${data.display_name}.`;
              $.ajax({
                url: API_ENDPOINT.HISTORY.CREATE_HISTORY,
                method: 'POST',
                headers: {
                  'Authorization': ACCESS_TOKEN,
                },
                data: {
                  batchId: batchId,
                  action: actionText,
                },
                success: function () {
                },
                error: function () {
                }
              });
            }
          });
        });
      });

      $('#billsTable tbody').on('click', '.btn-forward-batch', function () {
        const row = $(this).parents('tr')[0];
        const data = billsTable.row(row).data();
        $.ajax({
          url: fillEndpointPlaceholder(API_ENDPOINT.BATCH.FORWARD_BATCH, { id: data.batchId }),
          type: 'PUT',
          beforeSend: function (request) {
            request.setRequestHeader("Authorization", ACCESS_TOKEN);
          },
          success: function (result) {
            alert('Chuyển tiếp thành công');
            billsTable.ajax.reload();
          },
          error: function (error) {
            alert('Chuyển tiếp thất bại');
          }
        });
      });
    });
  </script>
</body>

</html>